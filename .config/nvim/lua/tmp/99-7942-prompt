<DIRECTIONS>
hello
</DIRECTIONS>
<Context>
You receive a selection in neovim that you need to replace with new code.
The selection's contents may contain notes, incorporate the notes every time if there are some.
consider the context of the selection and what you are suppose to be implementing
<SELECTION_LOCATION>
range(point(388,1),point(390,5))
</SELECTION_LOCATION>
<SELECTION_CONTENT>
vim.keymap.set("v", "<leader>9v", function()
	_99.visual()
end)
</SELECTION_CONTENT>
<FILE_CONTAINING_SELECTION>
vim.pack.add({
	{ src = "https://github.com/nvim-lua/plenary.nvim" },
	{ src = "https://github.com/nvim-treesitter/nvim-treesitter" },
	{ src = "https://github.com/wellle/context.vim" },
	{ src = "https://github.com/neovim/nvim-lspconfig" },
	{ src = "https://github.com/stevearc/conform.nvim" },
	{ src = "https://github.com/esmuellert/nvim-eslint" },
	{ src = "https://github.com/mason-org/mason.nvim" },
	{ src = "https://github.com/mason-org/mason-lspconfig.nvim" },
	-- { src = "https://github.com/WhoIsSethDaniel/mason-tool-installer.nvim" },
	{ src = "https://github.com/stevearc/oil.nvim" },
	{ src = "https://github.com/benomahony/oil-git-status.nvim" },
	{ src = "https://github.com/JezerM/oil-lsp-diagnostics.nvim" },
	{ src = "https://github.com/ibhagwan/fzf-lua" },
	{ src = "https://github.com/lewis6991/gitsigns.nvim" },
	{ src = "https://github.com/j-hui/fidget.nvim" },
	{
		src = "https://github.com/saghen/blink.cmp",
		version = vim.version.range("^1"),
	},
	{ src = "https://github.com/tpope/vim-fugitive" },
	{ src = "https://github.com/tpope/vim-rhubarb" },
	{ src = "https://github.com/barrettruth/diffs.nvim" },
	{ src = "https://github.com/hrsh7th/nvim-cmp" }, 
	{ src = "https://github.com/ThePrimeagen/99" },
})

local ok_ts, ts_configs = pcall(require, "nvim-treesitter.configs")
if ok_ts then
	ts_configs.setup({
		ensure_installed = {
			"lua",
			"vim",
			"vimdoc",
			"query",
			"bash",
			"json",
			"html",
			"css",
			"javascript",
			"typescript",
			"tsx",
			"python",
			"rust",
		},
		auto_install = true,
		highlight = { enable = true },
		indent = { enable = true },
		incremental_selection = {
			enable = true,
			keymaps = {
				init_selection = "gnn",
				node_incremental = "grn",
				scope_incremental = "grc",
				node_decremental = "grm",
			},
		},
	})
end

require("conform").setup({
	formatters_by_ft = {
		lua = { "stylua" },
		-- Conform will run multiple formatters sequentially
		python = { "isort", "black" },
		-- You can customize some of the format options for the filetype (:help conform.format)
		rust = { "rustfmt", lsp_format = "fallback" },
		-- Conform will run the first available formatter
		javascript = { "prettierd", "prettier", stop_after_first = true },
		javascriptreact = { "prettierd", "prettier", stop_after_first = true },
		typescript = { "prettierd", "prettier", stop_after_first = true },
		typescriptreact = { "prettierd", "prettier", stop_after_first = true },
		bash = { "beautysh" },
	},
})

vim.api.nvim_create_user_command("Format", function(args)
	local range = nil
	if args.count ~= -1 then
		local end_line = vim.api.nvim_buf_get_lines(0, args.line2 - 1, args.line2, true)[1]
		range = {
			start = { args.line1, 0 },
			["end"] = { args.line2, end_line:len() },
		}
	end
	require("conform").format({ async = true, lsp_format = "fallback", range = range }, function(err, did_edit)
		print(did_edit)
	end)
end, { range = true })

require("nvim-eslint").setup({})

require("oil").setup({
	win_options = {
		signcolumn = "yes:2",
	},
	view_options = {
		show_hidden = true,
	},
})

require("oil-git-status").setup({
	show_ignored = true,
	symbols = {
		index = {
			["!"] = "!",
			["?"] = "?",
			["A"] = "A",
			["C"] = "C",
			["D"] = "D",
			["M"] = "M",
			["R"] = "R",
			["T"] = "T",
			["U"] = "U",
			[" "] = " ",
		},
		working_tree = {
			["!"] = "!",
			["?"] = "?",
			["A"] = "A",
			["C"] = "C",
			["D"] = "D",
			["M"] = "M",
			["R"] = "R",
			["T"] = "T",
			["U"] = "U",
			[" "] = " ",
		},
	},
})

require("oil-lsp-diagnostics").setup({})

require("mason").setup({})

require("mason-lspconfig").setup({
	automatic_enable = {
		exclude = {
			"ts_ls",
		},
	},
	ensure_installed = {
		"lua_ls",
		"vtsls",
		"html",
		"cssls",
		"jsonls",
		"bashls",
		"pyright",
	},
})

require("gitsigns").setup({
	on_attach = function(bufnr)
		local gitsigns = require("gitsigns")

		local function map(mode, l, r, opts)
			opts = opts or {}
			opts.buffer = bufnr
			vim.keymap.set(mode, l, r, opts)
		end

		-----------------------------------------------------------------------
		-- Hunk Navigation
		-----------------------------------------------------------------------
		map("n", "]c", function()
			if vim.wo.diff then
				vim.cmd.normal({ "]c", bang = true })
			else
				gitsigns.nav_hunk("next")
			end
		end) -- Next git hunk (or diff change)

		map("n", "[c", function()
			if vim.wo.diff then
				vim.cmd.normal({ "[c", bang = true })
			else
				gitsigns.nav_hunk("prev")
			end
		end) -- Previous git hunk (or diff change)

		-----------------------------------------------------------------------
		-- Staging & Reset
		-----------------------------------------------------------------------
		map("n", "<leader>hs", gitsigns.stage_hunk) -- Stage hunk under cursor
		map("n", "<leader>hr", gitsigns.reset_hunk) -- Reset hunk under cursor
		map("v", "<leader>hs", function()
			gitsigns.stage_hunk({ vim.fn.line("."), vim.fn.line("v") })
		end) -- Stage selected lines
		map("v", "<leader>hr", function()
			gitsigns.reset_hunk({ vim.fn.line("."), vim.fn.line("v") })
		end) -- Reset selected lines
		map("n", "<leader>hS", gitsigns.stage_buffer) -- Stage entire buffer
		map("n", "<leader>hR", gitsigns.reset_buffer) -- Reset entire buffer

		-----------------------------------------------------------------------
		-- Preview & Diff
		-----------------------------------------------------------------------
		map("n", "<leader>hp", gitsigns.preview_hunk) -- Preview hunk in popup
		map("n", "<leader>hi", gitsigns.preview_hunk_inline) -- Preview hunk inline
		map("n", "<leader>hd", gitsigns.diffthis) -- Diff against index
		map("n", "<leader>hD", function()
			gitsigns.diffthis("~")
		end) -- Diff against last commit

		-----------------------------------------------------------------------
		-- Blame
		-----------------------------------------------------------------------
		map("n", "<leader>hb", function()
			gitsigns.blame_line({ full = true })
		end) -- Show full blame for current line

		-----------------------------------------------------------------------
		-- Quickfix
		-----------------------------------------------------------------------
		map("n", "<leader>hq", gitsigns.setqflist) -- Send buffer hunks to quickfix
		map("n", "<leader>hQ", function()
			gitsigns.setqflist("all")
		end) -- Send all hunks to quickfix

		-----------------------------------------------------------------------
		-- Toggles
		-----------------------------------------------------------------------
		map("n", "<leader>tb", gitsigns.toggle_current_line_blame) -- Toggle inline blame
		map("n", "<leader>tw", gitsigns.toggle_word_diff) -- Toggle word diff

		-----------------------------------------------------------------------
		-- Text Object
		-----------------------------------------------------------------------
		map({ "o", "x" }, "ih", gitsigns.select_hunk) -- Select hunk (inner)
	end,
})

require("fidget").setup({})

require("blink.cmp").setup({
	fuzzy = { implementation = "prefer_rust_with_warning" },
	signature = { enabled = true },
	keymap = {
		preset = "default",
		["<CR>"] = { "accept", "fallback" }, -- Accept completion or newline
		["<C-space>"] = {}, -- Disabled
		["<C-p>"] = {}, -- Disabled
		["<Tab>"] = {}, -- Disabled
		["<S-Tab>"] = {}, -- Disabled
		["<C-y>"] = { "show", "show_documentation", "hide_documentation" }, -- Toggle completion/docs
		["<C-n>"] = { "select_and_accept" }, -- Select and accept completion
		["<C-k>"] = { "select_prev", "fallback" }, -- Select previous item
		["<C-j>"] = { "select_next", "fallback" }, -- Select next item
		["<C-b>"] = { "scroll_documentation_down", "fallback" }, -- Scroll docs down
		["<C-f>"] = { "scroll_documentation_up", "fallback" }, -- Scroll docs up
		["<C-l>"] = { "snippet_forward", "fallback" }, -- Jump to next snippet placeholder
		["<C-h>"] = { "snippet_backward", "fallback" }, -- Jump to previous snippet placeholder
	},

	appearance = {
		use_nvim_cmp_as_default = true,
		nerd_font_variant = "normal",
	},

	completion = {
		documentation = {
			auto_show = true,
			auto_show_delay_ms = 200,
		},
	},

	cmdline = {
		keymap = {
			preset = "inherit",
			["<CR>"] = { "accept_and_enter", "fallback" }, -- Accept and execute command
		},
	},

	sources = { default = { "lsp" } },
})

local actions = require("fzf-lua.actions")
require("fzf-lua").setup({
	winopts = {
		height = 1,
		width = 1,
		backdrop = 85,
		preview = {
			horizontal = "right:70%",
		},
	},
	keymap = {
		-- Neovim builtin keymaps (work in results pane)
		builtin = {
			["<C-f>"] = "preview-page-down", -- Scroll preview down
			["<C-b>"] = "preview-page-up", -- Scroll preview up
			["<C-p>"] = "toggle-preview", -- Toggle preview pane
		},
		-- FZF keymaps (work in fuzzy finder input)
		fzf = {
			["ctrl-a"] = "toggle-all", -- Toggle all selections
			["ctrl-t"] = "first", -- Jump to first result
			["ctrl-g"] = "last", -- Jump to last result
			["ctrl-d"] = "half-page-down", -- Scroll results down
			["ctrl-u"] = "half-page-up", -- Scroll results up
		},
	},
	actions = {
		-- File picker actions
		files = {
			["ctrl-q"] = actions.file_sel_to_qf, -- Send selection to quickfix
			["ctrl-n"] = actions.toggle_ignore, -- Toggle gitignore filter
			["ctrl-h"] = actions.toggle_hidden, -- Toggle hidden files
			["enter"] = actions.file_edit_or_qf, -- Open file or send multiple to quickfix
		},
	},
})
local _99 = require("99")

-- For logging that is to a file if you wish to trace through requests
-- for reporting bugs, i would not rely on this, but instead the provided
-- logging mechanisms within 99.  This is for more debugging purposes
local cwd = vim.uv.cwd()
local basename = vim.fs.basename(cwd)

_99.setup({
	provider = _99.ClaudeCodeProvider,  -- default: OpenCodeProvider
	logger = {
		level = _99.DEBUG,
		path = "/tmp/" .. basename .. ".99.debug",
		print_on_error = true,
	},

	--- Completions: #rules and @files in the prompt buffer
	completion = {
		-- I am going to disable these until i understand the
		-- problem better.  Inside of cursor rules there is also
		-- application rules, which means i need to apply these
		-- differently
		-- cursor_rules = "<custom path to cursor rules>"

		--- A list of folders where you have your own SKILL.md
		--- Expected format:
		--- /path/to/dir/<skill_name>/SKILL.md
		---
		--- Example:
		--- Input Path:
		--- "scratch/custom_rules/"
		---
		--- Output Rules:
		--- {path = "scratch/custom_rules/vim/SKILL.md", name = "vim"},
		--- ... the other rules in that dir ...
		---
		custom_rules = {
			"scratch/custom_rules/",
		},

		--- Configure @file completion (all fields optional, sensible defaults)
		files = {
			-- enabled = true,
			-- max_file_size = 102400,     -- bytes, skip files larger than this
			-- max_files = 5000,            -- cap on total discovered files
			-- exclude = { ".env", ".env.*", "node_modules", ".git", ... },
		},

		--- What autocomplete do you use.  We currently only
		--- support cmp right now
		source = "cmp",
	},

	--- WARNING: if you change cwd then this is likely broken
	--- ill likely fix this in a later change
	---
	--- md_files is a list of files to look for and auto add based on the location
	--- of the originating request.  That means if you are at /foo/bar/baz.lua
	--- the system will automagically look for:
	--- /foo/bar/AGENT.md
	--- /foo/AGENT.md
	--- assuming that /foo is project root (based on cwd)
	md_files = {
		"AGENT.md",
	},
})

-- take extra note that i have visual selection only in v mode
-- technically whatever your last visual selection is, will be used
-- so i have this set to visual mode so i dont screw up and use an
-- old visual selection
--
-- likely ill add a mode check and assert on required visual mode
-- so just prepare for it now
vim.keymap.set("v", "<leader>9v", function()
	_99.visual()
end)

--- if you have a request you dont want to make any changes, just cancel it
vim.keymap.set("v", "<leader>9s", function()
	_99.stop_all_requests()
end)
</FILE_CONTAINING_SELECTION>

</Context>

<MustObey>
NEVER alter any file other than TEMP_FILE.
never provide the requested changes as conversational output. Return only the code.
ONLY provide requested changes by writing the change to TEMP_FILE

never attempt to read TEMP_FILE.
It is purely for output.
Previous contents, which may not exist, can be written over without worry
After writing TEMP_FILE once you should be done.  Be done and end the session.

</MustObey>
<TEMP_FILE>/home/bill/dotfiles/neovim/.config/nvim/lua/tmp/99-7942</TEMP_FILE>